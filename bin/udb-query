#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Long;
use Pod::Usage;
use Switch;

use FindBin qw($RealBin);
use lib "$RealBin/../lib";
use BrownCS::udb::Schema;
use BrownCS::udb::Console qw(:all);
use BrownCS::udb::Search qw(:all);

# Print a simple help message.
sub usage {
  my ($exit_status) = @_;
  pod2usage({ -exitval => $exit_status, -verbose => 1});
}

my $help = 0;
my $surplus = 0;

GetOptions (
  'help|h' => \$help, 
  'surplus|s' => \$surplus,
) or usage(1);
usage(0) if $help;

my $udb = BrownCS::udb::Schema->connect;
my $uc = new BrownCS::udb::Console(udb => $udb);

if (@ARGV != 2) {
  usage(2);
}

my $type = shift;
my $string = shift;
my $success = 0;
my @results;

switch($type) {

  case "brownid" {
    ($success, @results) = search_brown_id($udb)->($string,1);
  }
  case "comment" {
    ($success, @results) = search_comment($udb)->($string,1);
  }
  case "contact" {
    ($success, @results) = search_contact($udb)->($string,1);
  }
  case "device" {
    ($success, @results) = search_device($udb)->($string,1);
  }
  case "dns" {
    ($success, @results) = search_dns($udb)->($string,1);
  }
  case "po" {
    ($success, @results) = search_po($udb)->($string,1);
  }
  case "room" {
    ($success, @results) = search_room($udb)->($string,1);
  }
  case "serial" {
    ($success, @results) = search_serial($udb)->($string,1);
  }
  case "walljack" {
    ($success, @results) = search_walljack($udb)->($string,1);
  }
  else {
    print "Unknown search type\n";
    usage(2);
  }
}

if ($success) {
  print "Found the following matching devices:\n\n";
  foreach my $result (@results) {
    print "$result\n";
  }
  print "\n";
} else {
  print "No matching results found\n";
}

__END__

=head1 NAME

udb-query - Query for a variety of data in udb.

=head1 SYNOPSIS

udb-query [-hs] <type of search> <search string>

  -h        - help information
  -s        - include surplus information in searches

where <type of search> can be one of:

  brownid   - search for a Brown ID number
  comment   - search within the comment fields
  contact   - search for a device whose contact is a given user
  device    - search for a given device name
  dns       - search for a given dns name
  room      - search for devices within a given room
  serial    - search for a given serial number
  walljack  - search for devices connected to a given walljack

=head1 DESCRIPTION

udb-query provides a pre-defined number of queries a user can perform on the udb data.  It is intended to provide an easy way to search for the most common information tstaff members need to retrieve.

=head1 OPTIONS

=over

=item B<-h>, B<--help>

Print a help message and exit.

=back

=head1 AUTHORS

Aleks Bromfield, Paul McCann, Mark Dieterich.

=head1 SEE ALSO

B<udb>

=cut

